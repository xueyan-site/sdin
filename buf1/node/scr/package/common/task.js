"use strict";var e=require("@babel/runtime/helpers/interopRequireDefault"),l=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:!0}),exports.compile=b,exports.handleAssets=w,exports.handleDefine=x,exports.handleTypes=g,exports.handleScript=q;var n=e(require("@babel/runtime/regenerator")),t=e(require("@babel/runtime/helpers/asyncToGenerator")),i=e(require("gulp")),a=e(require("gulp-babel")),r=c(require("gulp-typescript")),s=e(require("gulp-uglify")),o=e(require("gulp-filter")),d=require("../../../utl/exec"),u=require("../../../utl/read"),f=require("./babel");function p(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(p=function(e){return e?r:t})(e)}function c(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==l(e)&&"function"!=typeof e)return{default:e};t=p(t);if(t&&t.has(e))return t.get(e);var r,u,n={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&((u=i?Object.getOwnPropertyDescriptor(e,r):null)&&(u.get||u.set)?Object.defineProperty(n,r,u):n[r]=e[r]);return n.default=e,t&&t.set(e,n),n}function b(e,t){return y.apply(this,arguments)}function y(){return(y=(0,t.default)(n.default.mark(function e(t,r){var u;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return u=Date.now(),e.next=3,x(t,r);case 3:return e.next=5,Promise.all([w(t,r),g(t)]);case 5:return e.next=7,Promise.all([q(t,"web",r),q(t,"node",r)]);case 7:return e.abrupt("return",Date.now()-u);case 8:case"end":return e.stop()}},e)}))).apply(this,arguments)}function w(e,t){if(e.buildWeb||e.buildNode)return(0,d.pipeline)(i.default.src(["**/*.ts","**/*.tsx","**/*.js","**/*.jsx"],{cwd:e.src}),t&&(0,o.default)(t),e.buildWeb&&i.default.dest(e.webDist),e.buildNode&&i.default.dest(e.nodeDist))}function x(e,t){if(e.buildTypes)return(0,d.pipeline)(i.default.src(["**/*.d.ts","**/*.d.tsx"],{cwd:e.src}),t&&(0,o.default)(t),i.default.dest(e.defDist))}var h=(0,u.withCache)(function(e){return r.default.createProject(e.tsc,{declaration:!0,removeComments:!1})});function g(e){if(e.buildTypes){var t=h(e);return(0,d.pipeline)(t.src(),t(r.reporter.fullReporter()),function(e){return e.dts},i.default.dest(e.defDist))}}function q(e,t,r){if((e.buildWeb||"web"!==t)&&(e.buildNode||"node"!==t)){var u=/\.d\.tsx?$/,n=/\.test\./;return(0,d.pipeline)(i.default.src(["**/*.ts","**/*.tsx","**/*.js","**/*.jsx"],{cwd:e.src}),(0,o.default)(function(e){return!(r&&!r(e))&&(!u.test(e.path)&&!n.test(e.path))}),(0,a.default)((0,f.getBabelOptions)(e,t)),e.useUglify&&(0,s.default)({mangle:{toplevel:!0}}),i.default.dest("web"===t?e.webDist:e.nodeDist))}}