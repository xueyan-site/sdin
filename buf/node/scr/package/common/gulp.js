"use strict";var e=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.compile=c,exports.handleAssets=h,exports.handleDefine=m,exports.handleTypes=x,exports.handleScript=w;var n=e(require("@babel/runtime/regenerator")),t=e(require("@babel/runtime/helpers/asyncToGenerator")),u=e(require("gulp")),i=e(require("gulp-babel")),r=e(require("gulp-typescript")),l=e(require("gulp-uglify")),s=e(require("gulp-filter")),a=require("../../../utl/exec"),d=require("../common/babel"),o=/\.(t|j)sx?$/,p=/\.d\.tsx?$/,f=/\.test\./;function c(e,t){return b.apply(this,arguments)}function b(){return(b=(0,t.default)(n.default.mark(function e(t,r){var u;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return u=Date.now(),e.next=3,m(t,r);case 3:return e.next=5,Promise.all([h(t,r),x(t)]);case 5:return e.next=7,Promise.all([w(t,"web",r),w(t,"node",r)]);case 7:return e.abrupt("return",Date.now()-u);case 8:case"end":return e.stop()}},e)}))).apply(this,arguments)}function h(e,t){if(e.buildWeb||e.buildNode)return(0,a.pipeline)(u.default.src("**/*",{cwd:e.src}),(0,s.default)(function(e){return!(t&&!t(e))&&!o.test(e.path)}),e.buildWeb&&u.default.dest(e.webDist),e.buildNode&&u.default.dest(e.nodeDist))}function m(e,t){if(e.buildTypes)return(0,a.pipeline)(u.default.src("**/*",{cwd:e.src}),(0,s.default)(function(e){return!(t&&!t(e))&&p.test(e.path)}),u.default.dest(e.defDist))}function x(e){if(e.buildTypes){var t=r.default.createProject(e.tsc,{declaration:!0,removeComments:!1});return(0,a.pipeline)(t.src(),t(),function(e){return e.dts},u.default.dest(e.defDist))}}function w(e,t,r){if((e.buildWeb||"web"!==t)&&(e.buildNode||"node"!==t))return(0,a.pipeline)(u.default.src("**/*",{cwd:e.src}),(0,s.default)(function(e){return!(r&&!r(e))&&(o.test(e.path)&&!p.test(e.path)&&!f.test(e.path))}),(0,i.default)((0,d.getBabelOptions)(e,t)),e.useUglify&&(0,l.default)({mangle:{toplevel:!0}}),u.default.dest("web"===t?e.webDist:e.nodeDist))}