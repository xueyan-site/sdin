"use strict";var e=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.deepRead=s,exports.withCache=o,exports.readJsonSync=c,exports.readGitConfigSync=f,exports.readPackageInfoSync=l;var h=e(require("@babel/runtime/regenerator")),t=e(require("@babel/runtime/helpers/typeof")),r=e(require("@babel/runtime/helpers/asyncToGenerator")),n=require("child_process"),d=e(require("fs-extra")),a=require("lodash"),p=require("./path");function x(e){return i.apply(this,arguments)}function i(){return(i=(0,r.default)(h.default.mark(function e(r){var t,n,a,i,s,o,u,c,f,l;return h.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.name,n=r.source,a=r.offset,i=r.current,s=r.filter,o=r.handler,u=d.default.statSync(i),s)return e.next=5,s({name:t,offset:a,source:n,current:i,stats:u});e.next=8;break;case 5:if(e.sent){e.next=8;break}return e.abrupt("return");case 8:if(u.isFile())return e.next=11,o({name:t,offset:a,source:n,current:i,stats:u});e.next=13;break;case 11:e.next=25;break;case 13:if(u.isDirectory())return e.next=16,d.default.readdir(i);e.next=25;break;case 16:c=e.sent,f=0;case 18:if(f<c.length)return l=c[f],e.next=22,x({filter:s,handler:o,source:n,name:l,offset:(0,p.joinPath)(a,l),current:(0,p.withPath)(i,l)});e.next=25;break;case 22:f++,e.next=18;break;case 25:case"end":return e.stop()}},e)}))).apply(this,arguments)}function s(e,r,t){if(!d.default.existsSync(e))throw Error('failed to read "'.concat(e,'", please check whether the file is exists'));return x({source:e,filter:t,handler:r,offset:"",current:e,name:(0,p.basename)(e)})}function o(n,a){var i=new Map;return function(e,r){var t=i.get(e);return t||(t=n(e,r),i.set(e,t),a&&setTimeout(function(){i.delete(e)},a)),t}}var u=o(function(e){var r;return/\.json$/.test(e)?r=d.default.readJSONSync(e):/\.(js|mjs)$/.test(e)&&(r=require(e)),r},2e3);function c(e,r,t){if((0,a.isPlainObject)(e))return e;if(!(0,a.isString)(e))return{};r=r?(0,p.withPath)(r,e):e;if(!d.default.existsSync(r)){if(t)throw Error('"'.concat(r,'" does not exist'));return{}}e=u(r);if(t&&!(0,a.isPlainObject)(e))throw Error('failed to read "'.concat(r,'", please check whether the file content format is correct'));return e||{}}function f(){var e=(0,n.execSync)("git config --global --list").toString(),t={};if(e.split("\n").forEach(function(e){var r;!e||0<(r=e.indexOf("="))&&(0,a.set)(t,e.slice(0,r),e.slice(r+1))}),!t.user||!t.user.name||!t.user.email)throw Error("please config git global user name and email");return t}function l(e){var r=c("package.json",e,!0),e=r.author;if("object"===(0,t.default)(e)&&(r.author=e.name||"",e.email&&(r.author+=" <"+e.email+">")),!r.name||!r.version||!r.author)throw Error('package.json must contain "name", "version", "author" fields');return r}